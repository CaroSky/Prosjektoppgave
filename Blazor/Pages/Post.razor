@using Blazored.Toast.Services;
@using SharedModels.Entities
@using SharedModels.ViewModels
@using Blazor.Data;
@using System.Security.Claims
@using System.IdentityModel.Tokens.Jwt;


@page "/post/{Id:int}"

@inject NavigationManager NavigationManager
@inject PostService PostService
@inject CustomAuthenticationStateProvider AuthenticationStateProvider
@inject SignalRService SignalRService
@inject IToastService ToastService


<div>
    @foreach (var toast in toasts)
    {

        <p>@toast</p>

    }
</div>



@if (posts == null)
{
    <p>Loading posts...</p>
}

else
{

    @if (allowed && user.Identity.IsAuthenticated)
    {

        <button class="btn btn-success ml-auto" @onclick="@(() => CreatePostDialog("Create"))">Add New Post</button>
    }
    @foreach (var post in posts)
    {
        <div class="post-preview blog-post">
            <h2 class="blog-post-title">
                @post.Title
            </h2>
            <p class="blog-post-meta">@post.Created.ToString("yyyy-MM-dd") by @post.OwnerId</p>
            <p>@post.Content</p>

            <div>
                <Comment PostId="@post.PostId" />
            </div>
            <div class="d-flex justify-content-between align-items-center">
                <button class="btn btn-primary" @onclick="@(() => NavigateToComments(post.PostId))">View</button>
                @if (post.OwnerId == _userId)
                {
                    <div>
                        <button class="btn btn-secondary" @onclick="@(() => EditPostDialog("Update", post.PostId, post))">Edit</button>
                        <button class="btn btn-danger" @onclick="@(() => DeletePost(post.PostId))">Delete</button>
                    </div>
                }
            </div>
        </div>
       
    }



}
<PostDialogBox Title="@_titleDialog"
               post="@_viewEditPost"
               OnCancel="CancelPostDialog"
               OnSave="OnSavePostDialog"
@ref="_dialog"></PostDialogBox>


@code {
    [Parameter]
    public int Id { get; set; }
    //private List<SharedModels.Entities.Post> posts;
    private SharedModels.Entities.Post _post = new SharedModels.Entities.Post();
    private List<string> toasts = new List<string>();
    private PostCreateViewModel _viewPost = new PostCreateViewModel();
    private PostEditViewModel _viewEditPost = new SharedModels.ViewModels.PostEditViewModel();
    private string _titleDialog;
    private PostDialogBox _dialog;
    private PostIndexViewModel postIndexViewModel;
    private bool allowed;
    private IEnumerable<SharedModels.Entities.Post> posts;
    private ClaimsPrincipal user;
    private string _username;
    private string _userId;
    private bool disposed = false;


    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        user = authState.User;
        _username = user?.FindFirst(JwtRegisteredClaimNames.Sub)?.Value;
        _userId = user?.FindFirst(JwtRegisteredClaimNames.NameId)?.Value;


        await GetPostsForBlog(Id);
        _ = StartSignalRMessageListening();



        Console.WriteLine("Sjekker SignalR-forbindelsesstatus...");
        if (user.Identity.IsAuthenticated)
        {
            //_blogSubscriptionStatus = await BlogService.GetAllSubscriptionStatusesAsync();
            await SignalRService.InitializeConnection();
        }
        else
        {

            Console.WriteLine("ingen user");
        }


        _titleDialog = "title";
    }

    private async Task StartSignalRMessageListening()
    {
        while (!disposed)
        {
            var message = await SignalRService.WaitForMessageAsync();
            if (!string.IsNullOrEmpty(message))
            {
                HandleSignalRMessage(message);
            }
        }
    }

    private void CancelPostDialog()
    {
        _dialog.CloseDialog();
    }
    private async IAsyncEnumerable<string> WaitForMessages()
    {


        yield return await SignalRService.WaitForMessageAsync();

    }

    private async Task OnSavePostDialog()
    {
        if (_titleDialog == "Create")
        {
            // Konverter fra PostEditViewModel til PostCreateViewModel
            //EditViewmodel er i dialogboxen siden den inneholder alle verdiene edit og create trenger
            var createViewModel = new PostCreateViewModel
                {
                    Title = _viewEditPost.Title,
                    Content = _viewEditPost.Content,
                    BlogId = _viewEditPost.BlogId,
                    IsCommentAllowed = _viewEditPost.IsCommentAllowed
                };

            Console.WriteLine("Creating new post...");
            await PostService.CreatePostAsync(createViewModel);
            Console.WriteLine("New post created.");
        }
        else if (_titleDialog == "Update")
        {
            // Send PostEditViewModel direkte
            Console.WriteLine($"Updating post with ID {_viewEditPost.PostId}...");
            await PostService.UpdatePostAsync(_viewEditPost.PostId, _viewEditPost);
            Console.WriteLine($"Post with ID {_viewEditPost.PostId} updated.");
        }

        await GetPostsForBlog(Id);
        Console.WriteLine("Posts updated after save operation.");
        _dialog.CloseDialog();
        Console.WriteLine("Dialog closed.");
    }


    private async Task GetPostsForBlog(int blogId)
    {
        var postIndexViewModel = await PostService.GetPostsByBlogIdAsync(blogId);
        posts = postIndexViewModel.Posts;
        allowed = postIndexViewModel.IsPostAllowed;
    }




    private async Task DeletePost(int postId)
    {

        var success = await PostService.DeletePostAsync(postId);
        if (success)
        {

            await GetPostsForBlog(Id);
        }
        else
        {
            ToastService.ShowError("Kunne ikke slette innlegget.");
        }
    }



    private void CreatePostDialog(string title)
    {
        _post = new SharedModels.Entities.Post()
            {
                Created = DateTime.Now,

            };

        // Overfører verdier fra '_post' til '_viewEditPost'
        _viewEditPost = new PostEditViewModel()
            {
                BlogId = Id,
                IsCommentAllowed = true,
                Title = "",
                Content = "",
                Created = _post.Created
            };

        _titleDialog = "Create";
        _dialog.Show();
    }

    private void EditPostDialog(string title, int postId, SharedModels.Entities.Post post)
    {
        _post = post;
        _viewEditPost = new PostEditViewModel()
            {
                PostId = postId, // Setter postens ID
                BlogId = Id,
                Title = post.Title,
                Content = post.Content,
                Created = post.Created,
                IsCommentAllowed = post.IsCommentAllowed

            };
        _titleDialog = title;
        _dialog.Show();
    }



    void CancelDialog()
    {
        _dialog.CloseDialog();
    }

    private void NavigateToComments(int postId)
    {
        NavigationManager.NavigateTo($"/comment/{postId}");
    }

    private void AddToastMessage(string message)
    {
        toasts.Add(message);
        Console.WriteLine($"Toast added: {message}");
        Console.WriteLine($"Total toasts: {toasts.Count}");
        this.InvokeAsync(() => this.StateHasChanged()); // Tvinger komponenten til å oppdatere UI
    }

    private void RemoveToast(string message)
    {
        toasts.Remove(message);
        //StateHasChanged();
    }
    //Unngå minnelekasjer:
    public void Dispose()

    {
        disposed = true;
        SignalRService.OnMessageReceived -= HandleSignalRMessage;
    }
    private async void HandleSignalRMessage(string message)
    {
        await InvokeAsync(() =>
         {
             AddToastMessage(message);
             StateHasChanged();
         });
    }
}


